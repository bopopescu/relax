###############################################################################
#                                                                             #
# Copyright (C) 2008 Edward d'Auvergne                                        #
#                                                                             #
# This file is part of the program relax.                                     #
#                                                                             #
# relax is free software; you can redistribute it and/or modify               #
# it under the terms of the GNU General Public License as published by        #
# the Free Software Foundation; either version 2 of the License, or           #
# (at your option) any later version.                                         #
#                                                                             #
# relax is distributed in the hope that it will be useful,                    #
# but WITHOUT ANY WARRANTY; without even the implied warranty of              #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the               #
# GNU General Public License for more details.                                #
#                                                                             #
# You should have received a copy of the GNU General Public License           #
# along with relax; if not, write to the Free Software                        #
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA   #
#                                                                             #
###############################################################################

# Python module imports.
import sys
from unittest import _TextTestResult, TextTestRunner
try:
    from cStringIO import StringIO
except ImportError:
    from StringIO import StringIO


class _RelaxTestResult(_TextTestResult):
    """A replacement for the _TextTestResult class used by the normal TextTestRunner.

    This class is designed to catch STDOUT during the execution of each test and to prepend the
    output to the failure and error reports normally generated by TextTestRunner.
    """

    def startTest(self, test):
        """Override of the _TextTestResult.startTest() method.

        The start of STDOUT capture occurs here.
        """

        # Catch stdout.
        self.capt_stdout = StringIO()
        sys.stdout = self.capt_stdout

        # Execute the normal startTest method.
        _TextTestResult.startTest(self, test)


    def stopTest(self, test):
        """Override of the TestResult.stopTest() method.

        The end of STDOUT capture occurs here.
        """

        # Restore stdout.
        sys.stdout = sys.__stdout__

        # Close the buffer.
        self.capt_stdout.close()


class RelaxTestRunner(TextTestRunner):
    """A replacement unittest runner.

    This runner is designed to catch STDOUT during the execution of each test and to prepend the
    output to the failure and error reports normally generated by TextTestRunner.
    """

    def _makeResult(self):
        """Override of the TextTestRunner._makeResult() method."""

        # Run the tests.
        return _RelaxTestResult(self.stream, self.descriptions, self.verbosity)


    def run(self, test):
        """Override of the TextTestRunner.run() method."""

        # Execute the normal run method.
        result = TextTestRunner.run(self, test)

        #print "\n\n\n\n\n\n\n"
        #print dir(results)
        #print "\n\n"
        #print results.failures
        #print `buf.getvalue()`

        # Return the results object.
        return result
